<html>
	<head>
		<script src="js/xmlOutput.js"></script>
		 <style>
		#dcmSrc{
			position: absolute;
            top: 70px;
            left: 130px;
		}
		#xmlSrc{
			position: absolute;
            top: 110px;
            left: 130px;
		}
		#allcanvas{
		position: relative;
		}
		
        #myCanvas {
            position: absolute;
            cursor: pointer;
        }

        #drawCanvas {
            position: absolute;
            cursor: pointer;
        }
		
		#parameter {
			position: relative;
		}
		
		.dropdown {
			position: relative;
			display: inline-block;
		}
		.dropdown-content {
			display: none;
			position: absolute;
			background-color: #f9f9f9;
			min-width: 70px;
			cursor: pointer;
			z-index: 1;
		}
		.dropdown-content p:hover {
			background-color: #ddd;
			color: black;
		}
		.dropdown-content p:active{
			color: red;
		}
		.dropdown:hover .dropdown-content {
			display: block;
		}
		table {
            position:absolute;
			top:200px;
			left:500px;
        }
		
		.tableTxt{
			position:absolute;
			top:170px;
			left:500px;
		}
		
		.typeText{
			position:absolute;
			top:390px;
			left:500px;
		}
		
		#showSVG	{
			position: absolute;
            top: 390px;
            left: 700px;
		}
		
		#svgDisp	{
			position: absolute;
            top: 420px;
            left: 500px;
			height: 160;
			width: 320;
		}
		
		.slidecontainer {
		  width: 10%;
		  position: absolute;
		  top: 340px;
		  left:500px;
		}
		
		#smallCanvas {
		  position: absolute;
		  top: 52px;
		  left:950px;
		  border: 3px solid black;
		}
		
		#slidezoom {
		  width: 20%;
		  position: absolute;
		  top: 350px;
		  left:935px;
		}

		.slider {
		  -webkit-appearance: none;
		  height: 15px;
		  border-radius: 5px;
		  background: #d3d3d3;
		  outline: none;
		  opacity: 0.7;
		  -webkit-transition: .2s;
		  transition: opacity .2s;
		}

		.slider:hover {
		  opacity: 1;
		}

		.slider::-webkit-slider-thumb {
		  -webkit-appearance: none;
		  appearance: none;
		  width: 25px;
		  height: 25px;
		  border-radius: 50%;
		  background: #4CAF50;
		  cursor: pointer;
		}

		.slider::-moz-range-thumb {
		  width: 25px;
		  height: 25px;
		  border-radius: 50%;
		  background: #4CAF50;
		  cursor: pointer;
		}
    </style>
	<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/1.4.0/fabric.min.js"></script>
	</head>
		
	<body>
		<input type="number" size="16" id="wcenter">&nbsp;&nbsp;&nbsp;
		<input type="number" size="16" id="wwidth">     &nbsp;
		<button type="button" onclick="setPixel()" style="height: 4%; width: 4%">Enter</button><br>
		<div class="dropdown">
			<button class="btn btn-outline-light" >Annotation &#8711 </button>&nbsp;&nbsp;&nbsp;
			<div class="dropdown-content">
				<p onclick="Text()" >Text</p>
				<p onclick="Line()" >Line</p>
				<p onclick="Rect()" >Rectangle</p>
				<p onclick="Ellipse()" >Ellipse</p>
				<p onclick="Polygon()" >Polygon</p>
			</div>
		</div>

		<button type="button" onclick="windowLW()" style="height: 4%; width: 8%">Window L/W</button><br><br>
		DCM File Source: &nbsp;&nbsp;<input type="text" size="50" id="dcmSrc" onchange="dcmOnChange(this.value)"><br><br>
		XML File Source: &nbsp;&nbsp;<input type="text" size="50" id="xmlSrc" onchange="xmlOnChange(this.value)"><br><br>
		<button type="button" onclick="setIndex()" style="height: 4%; width: 8%; margin-left: 400px;">Get Image</button>
		<br><br><div id="allcanvas">
			<canvas id="myCanvas" width="400" height="400" style="border:1px solid black;"></canvas>
			<canvas id="drawCanvas" width="400" height="400"></canvas>
		</div>
		<button type="button" id="showSVG" onclick="showSVG()" style="height: 4%; width: 8%">Show SVG</button>
		<textarea id="svgDisp"></textarea>
		
		<canvas id="smallCanvas" width="200" height="200"></canvas>
		<input type="range" id="slidezoom" class="slider" min="0" max="250" value="50">
		
		<table>
            <tr>
                <td>
                    <button value="black" onclick="colorwidth(value)" style="background: black; color: white;
                        width: 40px; height: 40px;">
                    </button>
                </td>
                <td>
                    <button value="lightgray" onclick="colorwidth(value)" style="background: lightgray;color: white; 
                        width: 40px; height: 40px;">
                    </button>
                </td>
                <td>
                    <button value="white" onclick="colorwidth(value)" style="background: white; color: white;
                        width: 40px; height: 40px;">
                    </button>
                </td>
            </tr>
            <tr>
                <td>
                    <button value="red" onclick="colorwidth(value)" style="background: red; color: white;
                        width: 40px; height: 40px;">
                    </button>
                </td>
                <td>
                    <button value="green" onclick="colorwidth(value)" style="background: green; color: white;
                        width: 40px; height: 40px;">
                    </button>
                </td>
                <td>
                    <button value="blue" onclick="colorwidth(value)" style="background: blue; color: white;
                        width: 40px; height: 40px;">
                    </button>
                </td>
            </tr>
            <tr>
                <td>
                    <button value="yellow" onclick="colorwidth(value)" style="background: yellow; color: white;
                        width: 40px; height: 40px;">
                    </button>
                </td>
                <td>
                    <button value="purple" onclick="colorwidth(value)" style="background: purple; color: white;
                        width: 40px; height: 40px;">
                    </button>
                </td>
                <td>
                    <button value="pink" onclick="colorwidth(value)" style="background: pink; color: white;
                        width: 40px; height: 40px;">
                    </button>
                </td>
            </tr>
        </table>
		
		<p class="tableTxt">Border Color:</p>
		<input type="text" size="16" id="typeText" class="typeText" onkeypress="return writeText(event)" style="visibility: hidden;">&nbsp;&nbsp;&nbsp;
		<div class="slidecontainer">
			Border thickness: <br>
			<input type="range" min="1" max="10" value="2" class="slider" id="myRange">
		</div>
		
		<script>
			//canvas
			var canvas = document.getElementById("myCanvas"), ctx = canvas.getContext("2d");
			var drawCanvas = document.getElementById("drawCanvas"), drawCtx = drawCanvas.getContext("2d");
			var smallCanvas = document.getElementById("smallCanvas"), smallCtx = smallCanvas.getContext("2d");
			//end canvas
			
			//windowLW
			var WindowCenter, WindowWidth, Max, Min;
			var adjusting = false;
			//end windowLW
			
			//file path
			var dcmFile= "http://203.64.84.218/dicomWebServer/Study1/DCMfiles/imagingStudy/MR2S1IM9.dcm";	//"http://203.64.84.218/dicomWebServer/StudyN/DCMfiles/imagingStudy/CT_A.dcm";
			var xmlFile= "http://203.64.84.218/dicomWebServer/Study1/XMLfiles/imagingStudy/MR2S1IM9.xml";	//"http://203.64.84.218/dicomWebServer/StudyN/XMLfiles/imagingStudy/CT_A.xml";
			var jpgFile= "http://203.64.84.218:83/Study1/jpgFiles/MR2S1IM1.jpg";	//"jpeg/MR2S1IM1.jpg"; //http://203.64.84.218:83/Study1/DCMfiles/MR2S1IM1.dcm
			
			function dcmOnChange(val){
				dcmFile =  val;	//"http://203.64.84.218:83/Study1/DCMfiles/MR2S1IM1.dcm";	//document.getElementById("dcmSrc").value; //"DCMfiles/MR2S1IM1.dcm"	//imgDir/CT_A.dcm
			}
			function xmlOnChange(val){
				xmlFile =  val;	//"http://203.64.84.218:83/Study1/decodedXML/MR2S1IM1.xml";	//document.getElementById("xmlSrc").value; //"decodedXML/MR2S1IM1.xml"	//imgDir/CT_A.xml
			}
			//end file path
			
			//image size
			var ratioWidth, ratioHeight, pixelx, pixely, fixedRatioW, fixedRatioH;
			//end image size
			
			//annotation
			var paintline = false, paintrect=false, paintPolygon=false, paintEllipse=false, typeText=false;
			var startX, startY;
			var powX, powY;
			var svgstr;
			var line=0, rect=0, ellipse=0, polygon=0, text=0;
				//line
				var svgline = new Array(10);
				for (var i = 0; i < 10; i++) {
				  svgline[i] = new Array(4);
				}
				
				//rect
				var svgrect = new Array(10);
				for (var i = 0; i < 10; i++) {
				  svgrect[i] = new Array(6);
				}
				
				//ellipse
				var svgEllipse = new Array(10);
				for (var i = 0; i < 10; i++) {
				  svgEllipse[i] = new Array(6);
				}
				
				//text
				var svgText = new Array(10);
				for (var i = 0; i < 10; i++) {
				  svgText[i] = new Array(6);
				}
			var svgColor="black", svgStrokeWidth=2;
			//end annotation
			
			//setIndex();			
			var readoffset;
			function setIndex() {
				function req(file, callFunction) {
					var xhttp = new XMLHttpRequest();
					xhttp.open('GET', file, true);
					if (file == dcmFile) {
						xhttp.responseType = "arraybuffer";	//arraybuffer=binary file
					}
					xhttp.onreadystatechange = function () {
						if (xhttp.readyState == 4) {
							callFunction(this);
						}
					}
					xhttp.send();
				}
				
				req(dcmFile, function getDicom(xhttp) {
					dicomData = new DataView(xhttp.response);
					viewPort = { vw: imgMetaData.columns, vh: imgMetaData.rows, sx: 0, sy: 0, sw: imgMetaData.columns, sh: imgMetaData.rows, iw:384, ih: 384}; //v = view(canvas), s= source imagesfixedsw=viewPort.sw;	//512
					fixedRatioW= viewPort.vw/ viewPort.iw, fixedRatioH= viewPort.vh/ viewPort.ih;
					setPixel();
				});
				
				req(xmlFile, function getData(xhttp) {
					var x = xhttp.responseXML.getElementsByTagName("DicomAttribute");
					var value, keyword, i, y;
					for (i = 0; i < x.length; i++) {
						//y= x[i].childNodes[0].nodeName;
						keyword = x[i].getAttribute('keyword');
						if (keyword==null) keyword = x[i].getAttribute('Keyword');
						
						if (keyword == 'WindowCenter') 
							var readwc = x[i].getElementsByTagName('Value')[0].childNodes[0].nodeValue;
						if (keyword == 'WindowWidth')
							var readww = x[i].getElementsByTagName('Value')[0].childNodes[0].nodeValue;
						if (keyword == 'Rows')
							var readrow = x[i].getElementsByTagName('Value')[0].childNodes[0].nodeValue;
						if (keyword == 'Columns')
							var readcol = x[i].getElementsByTagName('Value')[0].childNodes[0].nodeValue;
						if (keyword == 'PixelData'){
							readoffset = x[i].getAttribute('offset');
							if (readoffset==null) readoffset = x[i].getAttribute('Offset');
						}
						if (keyword == 'SOPInstanceUID')
							UID = x[i].getElementsByTagName('Value')[0].childNodes[0].nodeValue;
					}
					imgMetaData = { rows: parseInt(readrow), columns: parseInt(readcol), storedBytes: 2, samplesPerPixel: 1, pixelDataOffset: parseInt(readoffset) }; //data dicom, samplesPerPixel 1 =b&w
					document.getElementById("wcenter").value = parseInt(readwc);
					document.getElementById("wwidth").value = parseInt(readww);
				});

				
				colorchange=1;
			}
		
			function setPixel() {
				var imageData;
				var x, y;
				var dicomPixelIndex;
				var pixelValue;
				var grayValue;
				WindowCenter = document.getElementById("wcenter").value;
				WindowWidth = document.getElementById("wwidth").value;
				Max = WindowCenter + WindowWidth / 2;
				Min = WindowCenter - WindowWidth / 2;
				
				canvas.width = viewPort.iw;
				canvas.height = viewPort.ih;
				drawCanvas.width = viewPort.iw;
				drawCanvas.height = viewPort.ih;
				adjustRatio(canvas);
				putImagetoCanvas(canvas, ctx, viewPort.sx, viewPort.sy);
				
				smallCanvas.width = viewPort.vw/2; //half of original image size
				smallCanvas.height = viewPort.vh/2; 
				adjustRatio(smallCanvas);
				putImagetoCanvas(smallCanvas, smallCtx, 0, 0);
			}
			
			function putImagetoCanvas(cnv, ctx, sx, sy){
				imageData = ctx.getImageData(0, 0, cnv.width, cnv.height)
				for (y = 0; y < cnv.height; y++) {
					for (x = 0; x < cnv.width; x++) {
						pixelx = sx + x * ratioWidth;
						pixelx = parseInt(pixelx);
						pixely = sy + y * ratioHeight;
						pixely = parseInt(pixely);
						// Get DICOM image pixel index
						if (pixelx >= 0 && pixelx < imgMetaData.columns && pixely >= 0 && pixely < imgMetaData.rows) {
							dicomPixelIndex = (pixely * imgMetaData.columns + pixelx) * imgMetaData.samplesPerPixel * imgMetaData.storedBytes + imgMetaData.pixelDataOffset;
							pixelValue = dicomData.getUint16(dicomPixelIndex, true); // true for littel endian
							if (pixelValue >= Max) grayValue = 255; // 灰階值 白
							else if (Min > pixelValue) grayValue = 0; // 灰階值 黑    if ((pvalue[i][j] == 1) GrayValue = 0; for mammography
							else grayValue = Math.round((pixelValue - Min) / WindowWidth * 256); //對數字做指定位數的四捨五入計算;電腦顯示值
							// Get the canvas pixel +  index
							var canvasPixelIndex = (y * cnv.width + x) * 4;
							//dicomData.getInt8  references to JS dataView and arrayBuffer  http://www.javascripture.com/ArrayBuffer
							imageData.data[canvasPixelIndex] = grayValue;     // Red
							imageData.data[canvasPixelIndex + 1] = grayValue; // Green
							imageData.data[canvasPixelIndex + 2] = grayValue;  // Blue
							imageData.data[canvasPixelIndex + 3] = 255;   // Alpha
						}
						else {
							imageData.data[canvasPixelIndex] = 0;     // Red
							imageData.data[canvasPixelIndex + 1] = 0; // Green
							imageData.data[canvasPixelIndex + 2] = 0;  // Blue
							imageData.data[canvasPixelIndex + 3] = 255;   // Alpha
						}
					}
				}
				ctx.putImageData(imageData, 0, 0);
			}
			
			function adjustRatio(cnv){
				var sw, sh;
				if(cnv.width==canvas.width){
					ratioWidth = viewPort.sw / cnv.width;
					ratioHeight = viewPort.sh / cnv.height;
				}
				else{
					ratioWidth = viewPort.vw / cnv.width;
					ratioHeight = viewPort.vh / cnv.height;
				}
			}
			
			<!-- zoom in and out slider -->
			var slider=document.getElementById("slidezoom"), oldvalues=0;
			slider.oninput=function(){
				
				var curVal= this.value-50;	//50 as 1, <50 means zoom out
				var values=curVal-oldvalues;
				oldvalues=curVal;
				viewPort.sx += values;
				viewPort.sy += values;
				viewPort.sw-=(2*values);
				viewPort.sh-=(2*values);
				adjustRatio(canvas);
				setPixel();
				
				//small Canvas
				startX = viewPort.sx/2; //e=mouse cursor, this=canvas original x, y
				startY = viewPort.sy/2 ;
				smallCtx.lineWidth = 3;
				smallCtx.rect(startX, startY, viewPort.sw/2, viewPort.sh/2);
				smallCtx.strokeStyle= "red";
				smallCtx.stroke();
				redrawAnnotation();
				//BrightnessDraw();
			}
			<!-- END zoom in and out slider -->
			
			<!-- small canvas panning -->
			smallCanvas.onmousedown= function(e){
				setPixel();
				//center: e.pageX= 1128 this.offsetLeft= 1000 viewPort.sw=512/4=128
				startX = e.pageX - this.offsetLeft-(viewPort.sw/4); //e=mouse cursor, this=canvas original x, y
				startY = e.pageY - this.offsetTop-(viewPort.sh/4);
				viewPort.sx=startX*2;	//small canvas size is 1/2 original image size
				viewPort.sy=startY*2; //center: smallCanvas.startY=128, mainCanvas.startY=256
				setPixel();
				smallCtx.rect(startX, startY, viewPort.sw/2, viewPort.sh/2);
				smallCtx.strokeStyle= "red";
				smallCtx.stroke();
				adjustRatio(canvas);
				redrawAnnotation();
			}
			<!-- END small canvas panning -->
			
			<!-- Window level/ width Adjustment -->
			function windowLW(){
				var nextCenter = WindowCenter;
				var nextWidth = WindowWidth;
				var state = 1; //1=塗鴉 2=直線 3=圓形 4=橢圓形 5=正方形 6=長方形 7=橡皮擦 8=註解

				drawCanvas.onmousedown = function (e) {
					adjusting = true;
					startX = e.clientX;
					startY = e.clientY;
				}
				drawCanvas.onmousemove = function (e) {
					if (adjusting == true) {
						var x = e.clientX;
						var y = e.clientY;
						nextCenter = parseInt(WindowCenter) + x - startX;
						nextWidth = parseInt(WindowWidth) + y - startY;
						document.getElementById("wcenter").value = nextCenter;
						document.getElementById("wwidth").value = nextWidth;
						setPixel();
						redrawAnnotation();
					}
				}
				drawCanvas.onmouseup = function (e) {
					if (adjusting == true) {
						adjusting = false;
						document.getElementById("wcenter").value = nextCenter;
						document.getElementById("wwidth").value = nextWidth;
						setPixel();
						redrawAnnotation();
					}
				}
			}
			<!-- END Window level/ width Adjustment -->
			
			<!-- stroke color -->
			function colorwidth(color) {
				svgColor= color;
				ctx.strokeStyle = color;
				drawCtx.strokeStyle = color;
				ctx.fillStyle = color;
			}
			<!-- END stroke color -->
			
			<!-- stroke color -->
			var slider = document.getElementById("myRange");
			var output = document.getElementById("demo");
			slider.oninput = function() {
				svgStrokeWidth= this.value;
				ctx.lineWidth = this.value;
				drawCtx.lineWidth = this.value;
			}
			<!-- END stroke color -->
			
			<!-- Annotation -->
			function Text(){
				drawCanvas.onmousedown = function (e) {
					typeText = true;
					startX = e.pageX - document.getElementById("allcanvas").offsetLeft; //e=mouse cursor, this=canvas original x,
					startY = e.pageY - document.getElementById("allcanvas").offsetTop;
					document.getElementById("typeText").style.visibility = "visible";
				}
			}
			
			function writeText(event){
				if (event.which == 13 || event.keyCode == 13){
					var val= document.getElementById("typeText").value;
					ctx.font="18px Arial";
					ctx.fillText(val,startX,startY);
					
					svgText[text][0]= startX;			//((startX+3)*oldsw)+oldsx;	
					svgText[text][1]= startY;		//((startY+10)*oldsh)+oldsy;
					svgText[text][2]=val;	
					svgText[text][3]=svgColor;
					svgText[text][4]="18px Arial";
					text++;
					typeText = false;	
					document.getElementById("typeText").style.visibility = "hidden";
				}
			}

			function Line() {
				drawCanvas.onmousedown = function (e) {
					paintline = true;
					startX = e.pageX - document.getElementById("allcanvas").offsetLeft; //e=mouse cursor, this=canvas original x,
					startY = e.pageY - document.getElementById("allcanvas").offsetTop;
				}

				drawCanvas.onmousemove = function (e) {
					drawCtx.clearRect(0, 0, 400, 400);
					var x2 = e.pageX - document.getElementById("allcanvas").offsetLeft, y2 = e.pageY - document.getElementById("allcanvas").offsetTop;
					if (paintline) {
						drawCtx.beginPath();
						drawCtx.moveTo(startX, startY);
						drawCtx.lineTo(x2, y2);
						drawCtx.stroke();

						drawCtx.fillStyle = "red";
						drawCtx.font = 1;
						powX = Math.pow((x2 - startX), 2);
						powY = Math.pow((y2 - startY), 2);

						var length = Math.sqrt((powX + powY), 2);
						length = (length).toFixed(2);
						
						//drawCtx.fillText(length + 'mm', (x2 + startX) / 2, (y2 + startY) / 2);
					}
				}

				drawCanvas.onmouseup = function (e) {
					paintline = false;
					var x2 = e.pageX - document.getElementById("allcanvas").offsetLeft, y2 = e.pageY - document.getElementById("allcanvas").offsetTop;
					var xxx= (startX*ratioWidth)+viewPort.sx, yyy= (startY*ratioHeight)+viewPort.sy, 
					zzz= (x2*ratioWidth)+viewPort.sx, zz= (y2*ratioHeight)+viewPort.sy;
					
					svgline[line][0]= startX;		//(startX*oldsw)+oldsx;
					svgline[line][1]= startY;		//(startY*oldsh)+oldsy;
					svgline[line][2]= x2;			//(x2*oldsw)+oldsx;	// normal: (400*1.28) + 0= 512;
					svgline[line][3]= y2;			//(y2*oldsh)+oldsy;
					powX = Math.pow((x2 - startX), 2);
					powY = Math.pow((y2 - startY), 2);
					var length = Math.sqrt((powX + powY), 2);
					svgline[line][4]= svgColor;
					svgline[line][5]= svgStrokeWidth;	//(length).toFixed(2);
					//document.getElementById("tt").value= txt;
					lineAgain(startX, startY, x2, y2, svgColor, svgStrokeWidth);
					line++;
				}
			}
		
			function Rect(){
			drawCanvas.onmousedown = function (e) {
					paintrect = true;
					startX = e.pageX - document.getElementById("allcanvas").offsetLeft; //e=mouse cursor, this=canvas original x,
					startY = e.pageY - document.getElementById("allcanvas").offsetTop;
				}
			drawCanvas.onmousemove = function (e) {
					
					drawCtx.clearRect(0, 0, 512, 512);
					var x2 = e.pageX - document.getElementById("allcanvas").offsetLeft, y2 = e.pageY - document.getElementById("allcanvas").offsetTop;
					var width=x2-startX, height=y2-startY;
					 
					if (paintrect) {
						drawCtx.beginPath();
						drawCtx.rect(startX, startY, width, height);
						drawCtx.stroke();
					}
				}
				drawCanvas.onmouseup = function (e) {
					paintrect = false;
					var x2 = e.pageX - document.getElementById("allcanvas").offsetLeft, y2 = e.pageY - document.getElementById("allcanvas").offsetTop;
					rectAgain(startX, startY, x2, y2);
					
					svgrect[rect][0]= startX;		//(startX*oldsw)+oldsx;
					svgrect[rect][1]= startY;		//(startY*oldsh)+oldsy;
					svgrect[rect][2]= x2;			//(x2*oldsw)+oldsx;
					svgrect[rect][3]= y2;			//(y2*oldsh)+oldsy;
					svgrect[rect][4]= svgColor;
					svgrect[rect][5]= svgStrokeWidth;
					rect++;
				}
			}
			
			var rx, ry;
			function Ellipse(){
				drawCanvas.onmousedown = function (e) {
					paintEllipse = true;
					startX = e.pageX - document.getElementById("allcanvas").offsetLeft; //e=mouse cursor, this=canvas original x,
					startY = e.pageY - document.getElementById("allcanvas").offsetTop;
				}
				
				drawCanvas.onmousemove = function (e) {
					drawCtx.clearRect(0, 0, 400, 400);
					var x2 = e.pageX - document.getElementById("allcanvas").offsetLeft, y2 = e.pageY - document.getElementById("allcanvas").offsetTop;
					
					if (paintEllipse) 
						drawEllipse(drawCtx, startX, startY, x2, y2);
				}
				
				drawCanvas.onmouseup = function (e) {
					paintEllipse = false;
					var x2 = e.pageX - document.getElementById("allcanvas").offsetLeft, y2 = e.pageY - document.getElementById("allcanvas").offsetTop;
					drawEllipse(ctx, startX, startY, x2, y2);
					
					svgEllipse[ellipse][0]=	startX;	//(startX*oldsw)+oldsx;
					svgEllipse[ellipse][1]=	startY;	//(startY*oldsh)+oldsy;
					svgEllipse[ellipse][2]=	rx;	//rx*oldsw;
					svgEllipse[ellipse][3]=	ry;	//ry*oldsh;
					svgEllipse[ellipse][4]= svgColor;
					svgEllipse[ellipse][5]= svgStrokeWidth;
					ellipse++;
				}
			}

			function drawEllipse(ctxType, startX, startY, x2, y2){
				rx = Math.abs(x2-startX);
				ry = Math.abs(y2-startY);
				ctxType.beginPath();
				ctxType.ellipse(startX, startY, ry, rx, Math.PI / 2, 0, 2 * Math.PI); //x, y, major radiusX, minor radiusY, rotation, startAngle, endAngle
				ctxType.stroke();
			}
			
			   <!-- var roof = null; -->
				<!-- var roofPoints = []; -->
				<!-- var lines = []; -->
				<!-- var lineCounter = 0; -->
				<!-- var drawingObject = {}; -->
				<!-- drawingObject.type = ""; -->
				<!-- drawingObject.background = ""; -->
				<!-- drawingObject.border = ""; -->

				<!-- function Point(x, y) { -->
					<!-- this.x = x; -->
					<!-- this.y = y; -->
				<!-- } -->
				
				function Polygon(){
					<!-- <svg width="400" height="400"><polygon points="100,10 300,210 170,250 123,234" style="stroke:pink;stroke-width:2;fill:none;"/> -->
				<!-- <polygon points="120,100 300,310 170,350" style="stroke:purple;stroke-width:5;fill:none;"/> -->
			<!-- </svg> -->
					document.getElementById("svgDisp").value= '<polygon points="220,10 300,210 170,250 123,234" style="fill:lime;stroke:purple;stroke-width:1" />';
				}
				<!-- function Polygon(){ -->
					<!-- if (drawingObject.type == "roof") { -->
						<!-- drawingObject.type = ""; -->
						<!-- lines.forEach(function(value, index, ar){ -->
							 <!-- canvas.remove(value); -->
						<!-- }); -->
						<!-- //canvas.remove(lines[lineCounter - 1]); -->
						<!-- roof = makeRoof(roofPoints); -->
						<!-- canvas.add(roof); -->
						<!-- canvas.renderAll(); -->
					<!-- } else { -->
						<!-- drawingObject.type = "roof"; // roof type -->
					<!-- } -->
				<!-- } -->
				
				<!-- myCanvas.onmousedown = function (e) { -->
					<!-- paintline = true; -->
					<!-- startX = e.pageX - document.getElementById("allcanvas").offsetLeft; //e=mouse cursor, this=canvas original x, -->
					<!-- startY = e.pageY - document.getElementById("allcanvas").offsetTop; -->
				<!-- } -->

				<!-- // canvas Drawing -->
			<!-- var canvas = new fabric.Canvas('myCanvas'); -->
				<!-- var x = 0; -->
				<!-- var y = 0; -->
				
				<!-- fabric.util.addListener(window,'dblclick', function(){  -->
						<!-- drawingObject.type = ""; -->
						<!-- lines.forEach(function(value, index, ar){ -->
							 <!-- canvas.remove(value); -->
						<!-- }); -->
						<!-- //canvas.remove(lines[lineCounter - 1]); -->
						<!-- roof = makeRoof(roofPoints); -->
						<!-- canvas.add(roof); -->
						<!-- canvas.renderAll(); -->
				  
					<!-- console.log("double click"); -->
					<!-- //clear arrays -->
					 <!-- roofPoints = []; -->
					 <!-- lines = []; -->
					 <!-- lineCounter = 0; -->
					
				<!-- }); -->

				<!-- canvas.on('mouse:down', function (options) { -->
					<!-- if (drawingObject.type == "roof") { -->
						<!-- paintPolygon= true; -->
						<!-- canvas.selection = false; -->
						<!-- setStartingPoint(options); // set x,y -->
						<!-- roofPoints.push(new Point(x, y)); -->
						<!-- var points = [x, y, x, y]; -->
						<!-- lines.push(new fabric.Line(points, { -->
							<!-- strokeWidth: 3, -->
							<!-- selectable: false, -->
							<!-- stroke: 'orange' -->
						<!-- }).setOriginX(x).setOriginY(y)); -->
						<!-- canvas.add(lines[lineCounter]); -->
						<!-- lineCounter++; -->
						<!-- canvas.on('mouse:up', function (options) { -->
							<!-- canvas.selection = true; -->
							<!-- paintPolygon= false; -->
						<!-- }); -->
					<!-- } -->
				<!-- }); -->
				<!-- canvas.on('mouse:move', function (options) { -->
					<!-- if (paintPolygon && lines[0] !== null && lines[0] !== undefined && drawingObject.type == "roof") { -->
						<!-- setStartingPoint(options); -->
						<!-- lines[lineCounter - 1].set({ -->
							<!-- x2: x, -->
							<!-- y2: y -->
						<!-- }); -->
						<!-- canvas.renderAll(); -->
					<!-- } -->
				<!-- }); -->

				<!-- function setStartingPoint(options) { -->
					<!-- x = options.e.pageX - document.getElementById("myCanvas").offsetLeft; -->
					<!-- y = options.e.pageY - 120- document.getElementById("myCanvas").offsetTop; -->
				<!-- } -->

				<!-- function makeRoof(roofPoints) { -->

					<!-- var left = findLeftPaddingForRoof(roofPoints); -->
					<!-- var top = findTopPaddingForRoof(roofPoints); -->
					<!-- roofPoints.push(new Point(roofPoints[0].x,roofPoints[0].y)) -->
					<!-- var roof = new fabric.Polyline(roofPoints, { -->
					<!-- fill: 'rgba(0,0,0,0)', -->
					<!-- stroke:'red' -->
					<!-- }); -->
					<!-- roof.set({ -->
						<!-- left: left, -->
						<!-- top: top, -->
					<!-- }); -->


					<!-- return roof; -->
				<!-- } -->

				<!-- function findTopPaddingForRoof(roofPoints) { -->
					<!-- var result = 999999; -->
					<!-- for (var f = 0; f < lineCounter; f++) { -->
						<!-- if (roofPoints[f].y < result) { -->
							<!-- result = roofPoints[f].y; -->
						<!-- } -->
					<!-- } -->
					<!-- return Math.abs(result); -->
				<!-- } -->

				<!-- function findLeftPaddingForRoof(roofPoints) { -->
					<!-- var result = 999999; -->
					<!-- for (var i = 0; i < lineCounter; i++) { -->
						<!-- if (roofPoints[i].x < result) { -->
							<!-- result = roofPoints[i].x; -->
						<!-- } -->
					<!-- } -->
					<!-- return Math.abs(result); -->
				<!-- } -->
			
			function redrawAnnotation(){
				//setPixel();
				adjustRatio(canvas);
				var isx= viewPort.sx/fixedRatioW;
				var isy= viewPort.sy/fixedRatioH;
				var iratioWidth= (viewPort.iw-isx-isx)/ viewPort.iw;
				var iratioHeight= (viewPort.ih-isy-isy)/ viewPort.ih;		
				
				for (var i=0;i<text;i++){ 
					textAgain((svgText[i][0]-isx)/ iratioWidth, (svgText[i][1]-isy)/ iratioHeight, svgText[i][2], svgText[i][3], svgText[i][4]); 
				}
				for (var i=0;i<line;i++){ 
					lineAgain((svgline[i][0]-isx)/ iratioWidth, (svgline[i][1]-isy)/ iratioHeight, (svgline[i][2]-isx)/ iratioWidth, (svgline[i][3]-isy)/ iratioHeight, svgline[i][4], svgline[i][5]); 
				}
				for (var i=0;i<rect;i++){ 
					rectAgain((svgrect[i][0]-isx)/ iratioWidth, (svgrect[i][1]-isy)/ iratioHeight, (svgrect[i][2]-isx)/ iratioWidth, (svgrect[i][3]-isy)/ iratioHeight, svgrect[i][4], svgrect[i][5]); 
				}
				for (var i=0;i<ellipse;i++){ 
					ellipseAgain((svgEllipse[i][0]-isx)/ iratioWidth, (svgEllipse[i][1]-isy)/ iratioHeight, svgEllipse[i][2]/ iratioWidth, svgEllipse[i][3]/ iratioHeight, svgEllipse[i][4], svgEllipse[i][5]); 
				}
				<!-- for (var i=0;i<polygon;i++){  -->
					<!-- polygonAgain(i);  -->
				<!-- } -->
			}
			
			function textAgain(startX, startY, val, color, fontstyle){
				ctx.beginPath();
				ctx.font= fontstyle;
				ctx.fillStyle= color;
				ctx.fillText(val,startX,startY);
			}
		
			function lineAgain(startX, startY, x2, y2, color, strokewidth){
				ctx.beginPath();
				ctx.strokeStyle= color;
				ctx.lineWidth = strokewidth;
				ctx.moveTo(startX, startY);
				ctx.lineTo(x2, y2);
				ctx.stroke();
				
				<!-- smallCtx.beginPath(); -->
				<!-- smallCtx.strokeStyle= color; -->
				<!-- smallCtx.lineWidth = strokewidth; -->
				<!-- adjustRatio(canvas); -->
				<!-- smallCtx.moveTo(startX*0.67, startY*0.67); -->
				<!-- smallCtx.lineTo(x2*0.67, y2*0.67); -->
				<!-- smallCtx.stroke(); -->
				//ctx.fillStyle = "red";
				//ctx.font = 3;
				//ctx.fillText(len + 'mm', (x2 + startX) / 2, (y2 + startY) / 2);
			}
			
			function rectAgain(startX, startY, x2, y2, color, strokewidth){
				var width=x2-startX, height=y2-startY;
				//document.getElementById("svgDisp").value+= startX + ", " + x2 + ", " +　startY + ", " + y2 + "\n";
				ctx.beginPath();
				ctx.strokeStyle= color;
				ctx.lineWidth = strokewidth;
				ctx.rect(startX, startY, width, height, color);
				ctx.stroke();
			}
			
			function ellipseAgain(startX, startY, ry, rx, color, strokewidth){
				ctx.beginPath();
				ctx.strokeStyle= color;
				ctx.lineWidth = strokewidth;
				ctx.ellipse(startX, startY, ry, rx, Math.PI / 2, 0, 2 * Math.PI); 
				ctx.stroke();
			}
			<!-- END Annotation -->
			
			function showSVG(){
				svgstr='<svg width="400" height="400">\n';
				for(var i=0; i<line; i++){
					svgstr+='<line x1="';
					svgstr+=parseInt(svgline[i][0]);
					svgstr+='" y1="';
					svgstr+=parseInt(svgline[i][1]);
					svgstr+='" x2="';
					svgstr+=parseInt(svgline[i][2]);
					svgstr+='" y2="';
					svgstr+=parseInt(svgline[i][3]);
					svgstr+='" stroke="' + svgline[i][4] + '" stroke-width="' + svgline[i][5] + '" fill="none"/>\n';
				}
				for(var i=0; i<rect; i++){
					var width=svgrect[i][2]-svgrect[i][0], height=svgrect[i][3]-svgrect[i][1];
					svgstr+='<rect x="';
					svgstr+=parseInt(svgrect[i][0]);
					svgstr+='" y="';
					svgstr+=parseInt(svgrect[i][1]);
					svgstr+='" width="';
					svgstr+=parseInt(width);
					svgstr+='" height="';
					svgstr+=parseInt(height);
					svgstr+='" stroke="' + svgrect[i][4] + '" stroke-width="' + svgrect[i][5] + '" fill="none"/>\n';
				}
				for(var i=0; i<ellipse; i++){
					svgstr+='<ellipse cx="';
					svgstr+=parseInt(svgEllipse[i][0]);
					svgstr+='" cy="';
					svgstr+=parseInt(svgEllipse[i][1]);
					svgstr+='" rx="';
					svgstr+=parseInt(svgEllipse[i][2]);
					svgstr+='" ry="';
					svgstr+=parseInt(svgEllipse[i][3]);
					svgstr+='" stroke="' + svgEllipse[i][4] + '" stroke-width="' + svgEllipse[i][5] + '" fill="none"/>\n';
				}
				
				for(var i=0; i<text; i++){
					svgstr+='<text x="';
					svgstr+=parseInt(svgText[i][0]);
					svgstr+='" y="';
					svgstr+=parseInt(svgText[i][1]);
					svgstr+='" style="fill:';
					svgstr+=svgText[i][3];
					svgstr+=';font:18px Arial" >';
					svgstr+=svgText[i][2];	
					svgstr+='"</text>\n';
				}
				
				<!-- for(var i=0; i<polygon; i++){ -->
					<!-- svgstr+='<polygon points="'; -->
					<!-- for() -->
					<!-- svgstr+=parseInt(svgText[i][0]) + " "; -->
					<!-- } -->
					<!-- svgstr+='" style="stroke:' + svgEllipse[i][4] + ';stroke-width:2;fill:none" />\n'; -->
				<!-- } -->
				
				svgstr+="</svg>";
				document.getElementById("svgDisp").value= svgstr;
				var svg=window.btoa(svgstr);
				var xmlStr = formInputsToXML('chest', document.URL, UID, svg, viewPort.vw, viewPort.vh, viewPort.sx, viewPort.sy, viewPort.sw, viewPort.sh, WindowCenter, WindowWidth, readoffset, dcmFile);
				postData(xmlStr);
				<!-- //mammoXML('architecturalDistortion', 'RID34261', '0001', 'Rt', '右側', 'C50.2', 'UIQ', 'UH', 'upper hemisphere', '', '', '', '', '', '', '', ''); -->
				<!-- setCookie("obs_id", obsID, 30); -->
				<!-- window.open("mammo.html", "_blank"); -->
			}
		</script>
	</body>
</html>